# Makefile for NullLogic Groupware @PACKAGE_VERSION@

include Rules.mak

all: _all
	@echo ""
	@echo "+-----------------------------------------------------------------------------+"
	@echo "| License:                                                                    |"
	@echo "| This software is subject to the GNU GPL, available in this distribution in  |"
	@echo "| the file Documentation/COPYING.  By continuing this installation process,   |"
	@echo "| you are bound by the terms of this license agreement.  If you do not agree  |"
	@echo "| with the terms of this license, you must abort the installation process at  |"
	@echo "| this point.                                                                 |"
	@echo "+-----------------------------------------------------------------------------+"
	@echo "| New installation:                                                           |"
	@echo "| If this is a new install, you can run 'make sslcert' to generate a new      |"
	@echo "| SSL certificate, before running 'make install'.                             |"
	@echo "+-----------------------------------------------------------------------------+"
	@echo "| Upgrade:                                                                    |"
	@echo "| If this is an upgrade, please stop any running instances of the server      |"
	@echo "| before running 'make install'.  After upgrading, you may need to run        |"
	@echo "| nullgw-dbutil to dump and restore the database.                             |"
	@echo "|                                                                             |"
	@echo "| If you are upgrading from a version prior to 1.3.20, you _must_ backup      |"
	@echo "| your db prior to installing this version, as 1.3.20+ cannot read older      |"
	@echo "| SQLite database files.                                                      |"
	@echo "+-----------------------------------------------------------------------------+"
	@echo ""
	@echo "Thank you for using NullLogic Groupware."
	@echo ""

_all: _sqlite _misc _dbutil _server _core_modules _httpd_modules

_sqlite:
	@echo "sqlite"
	@cd sqlite;./libsqlite_make build

_misc:
	@cp -p Documentation/COPYING distrib/COPYING
	@cp -p Documentation/COPYRIGHT distrib/COPYRIGHT
	@cp -p Documentation/README distrib/README
	@cp -p scripts/setup distrib/setup
	@cp -p scripts/nullgw-backup distrib/bin/nullgw-backup
	@cp -p scripts/nullgw-config distrib/bin/nullgw-config
	@cp -p scripts/rc.groupware distrib/bin/rc.groupware
	@chmod 0755 distrib/setup distrib/bin/nullgw-backup distrib/bin/nullgw-config distrib/bin/rc.groupware

_dbutil:
	@echo "dbutil"
	@cd dbutil;$(MAKE)

_server:
	@echo "server"
	@cd server;$(MAKE)

_core_modules:
	@echo "core_modules"
	@mkdir -p distrib/lib/core
	@cd modules/core_modules;$(MAKE)

_httpd_modules:
	@echo "httpd_modules"
	@mkdir -p distrib/lib/httpd
	@cd modules/httpd_modules;$(MAKE)

sslcert:
	openssl req -new -x509 -nodes -out distrib/etc/ssl-cert.pem -keyout distrib/etc/ssl-priv.pem -days 365

autoconf:
	@echo ifnames *.[ch]
	@echo autoscan
	@echo mv configure.scan configure.in
	@echo autoheader
	@echo autoconf

clean:
	@echo -n "Cleaning..."
	@chmod 0755 scripts/lxtool
	@cd dbutil;$(MAKE) clean
	@cd server;$(MAKE) clean
	@cd modules/core_modules;$(MAKE) clean
	@cd modules/httpd_modules;$(MAKE) clean
	@./scripts/lxtool clean
	@rm -f distrib/bin/* distrib/lib/*.so distrib/lib/httpd/*.so *~
	@rm -f distrib/etc/ssl-cert.pem distrib/etc/ssl-priv.pem
	@echo "done."

distclean: clean
	@cd sqlite;./libsqlite_make clean
	@rm -f `find -name *~`
	@echo -n "Running autoconf..."
	@autoconf
	@rm -rf autom4te.cache
	@rm -f config.log config.status include/config.h Makefile Rules.mak
	@chown -R 0:0 *
	@echo "done."

install: _all
	@chown -R 0:0 distrib/*
	@cd distrib;./setup

upgrade: _all
	@chown -R 0:0 distrib/*
	@cd distrib;./setup upgrade

wc:
	wc `find . -name *.[ch] ! -path './sqlite/*'`

dist:
	@chmod 0755 scripts/lxtool
	@./scripts/lxtool clean
	@$(MAKE)
	@./scripts/lxtool pack

slackdist:
	@chmod 0755 scripts/lxtool
	@./scripts/lxtool clean
	@$(MAKE)
	@./scripts/lxtool slackpack
