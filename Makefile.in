# Makefile for NullLogic Groupware @PACKAGE_VERSION@

include Rules.mak

all: _all
	@echo ""
	@echo "+-----------------------------------------------------------------------------+"
	@echo "| License:                                                                    |"
	@echo "| This software is subject to the GNU GPL, available in this distribution in  |"
	@echo "| the file Documentation/COPYING.  By continuing this installation process,   |"
	@echo "| you are bound by the terms of this license agreement.  If you do not agree  |"
	@echo "| with the terms of this license, you must abort the installation process at  |"
	@echo "| this point.                                                                 |"
	@echo "+-----------------------------------------------------------------------------+"
	@echo "| New installation:                                                           |"
	@echo "| If this is a new install, you can run 'make sslcert' to generate a new      |"
	@echo "| SSL certificate, before running 'make install'.                             |"
	@echo "+-----------------------------------------------------------------------------+"
	@echo "| Upgrade:                                                                    |"
	@echo "| If this is an upgrade, please stop any running instances of the server      |"
	@echo "| before running 'make install'.  After upgrading, you may need to run        |"
	@echo "| nullgw-dbutil to dump and restore the database.                             |"
	@echo "|                                                                             |"
	@echo "| If you are upgrading from a version prior to 1.3.20, you _must_ backup      |"
	@echo "| your db prior to installing this version, as 1.3.20+ cannot read older      |"
	@echo "| SQLite database files.                                                      |"
	@echo "+-----------------------------------------------------------------------------+"
	@echo ""
	@echo "Thank you for using NullLogic Groupware."
	@echo ""

_all: _misc _sqlite _dbutil _server _core_modules _ghttpd_modules _httpd_modules

_sqlite:
	@echo "sqlite"
	@cd sqlite;./libsqlite_make build

_misc:
	@cp -p Documentation/COPYING distrib/COPYING
	@cp -p Documentation/COPYRIGHT distrib/COPYRIGHT
	@cp -p Documentation/README distrib/README
	@cp -p scripts/setup distrib/setup
	@cp -p scripts/nullgw-backup distrib/bin/nullgw-backup
	@cp -p scripts/nullgw-config distrib/bin/nullgw-config
	@cp -p scripts/nullgw-init distrib/bin/nullgw-init
	@cp -p scripts/nullgw-init debian/nullgroupware.init
	@chmod 0644 distrib/COPYING distrib/COPYRIGHT distrib/README
	@chmod 0755 distrib/setup distrib/bin/nullgw-backup distrib/bin/nullgw-config distrib/bin/nullgw-init

_dbutil:
	@echo "dbutil"
	@cd dbutil;$(MAKE)

_server:
	@echo "server"
	@cd server;$(MAKE)

_core_modules:
	@echo "core_modules"
	@mkdir -p distrib/lib/core
	@cd modules/core_modules;$(MAKE)

_ghttpd_modules:
	@echo "ghttpd_modules"
	@mkdir -p distrib/lib/ghttpd
	@cd modules/ghttpd_modules;$(MAKE)

_httpd_modules:
	@echo "httpd_modules"
	@mkdir -p distrib/lib/httpd
	@cd modules/httpd_modules;$(MAKE)

sslcert:
	openssl req -new -x509 -nodes -out distrib/etc/ssl-cert.pem -keyout distrib/etc/ssl-priv.pem -days 365

clean:
	@cd dbutil;$(MAKE) clean
	@cd server;$(MAKE) clean
	@cd modules/core_modules;$(MAKE) clean
	@cd modules/ghttpd_modules;$(MAKE) clean
	@cd modules/httpd_modules;$(MAKE) clean
	@rm -f distrib/bin/* distrib/lib/*.so distrib/lib/ghttpd/*.so distrib/lib/httpd/*.so *~
	@rm -f distrib/etc/ssl-cert.pem distrib/etc/ssl-priv.pem

distclean: clean
	@cd sqlite;./libsqlite_make clean
	@chmod -R 0755 distrib
	@chmod -R 0755 distrib/bin
	@chmod -R 0770 distrib/etc
	@chmod -R 0755 distrib/lib
	@chmod -R 0770 distrib/var
	@chmod -R 0755 distrib/var/htdocs
	@chmod -R 0755 distrib/var/lang
	@chmod -R 0660 `find distrib/etc -name '*' -type f`
	@chmod -R 0660 `find distrib/var -name '*' -type f`
	@chmod -R 0644 `find distrib/var/htdocs -name '*' -type f`
	@chmod -R 0644 `find distrib/var/lang -name '*' -type f`
	@chown -R 0:0 *
	@rm -f distrib/COPYING distrib/COPYRIGHT distrib/README
	@rm -f distrib/setup distrib/bin/nullgw-backup distrib/bin/nullgw-config distrib/bin/nullgw-init
	@rm -f build-stamp config.log config.status include/config.h Makefile Rules.mak
	@rm -f `find -name *~`
	@rm -rf autom4te.cache

install: _all
	@chown -R 0:0 distrib/*
	@cd distrib;./setup

debinstall: _all
	@chown -R 0:0 distrib/*
	@cd distrib;./setup debian

upgrade: _all
	@chown -R 0:0 distrib/*
	@cd distrib;./setup upgrade

wc:
	wc `find . -name *.[ch] ! -path './sqlite/*'`

dist:
	@$(MAKE)
	@./scripts/pack pack

slackdist:
	@$(MAKE)
	@./scripts/pack slackpack
