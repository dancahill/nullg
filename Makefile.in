# Makefile for NullLogic Groupware @PACKAGE_VERSION@

include Rules.mak

all: _all
	@echo ""
	@echo "Finished compiling NullLogic Groupware."
	@echo ""
	@echo "If this is a new install, you can run 'make sslcert' to generate"
	@echo "a new SSL certificate."
	@echo ""
	@echo "If this is an upgrade, please stop any running instances of the"
	@echo "server before running 'make install'.  After upgrading, you may"
	@echo "need to run nullgw-dbutil to dump and restore the database."
	@echo ""
	@echo "The next step is to run 'make install'."
	@echo ""

_all: _sqlite _dbutil _server _server_modules _modules
	@cp -p scripts/setup distrib/setup
	@cp -p scripts/cron.daily distrib/bin/cron.daily
	@cp -p scripts/nullgw-config distrib/bin/nullgw-config
	@cp -p scripts/rc.groupware distrib/bin/rc.groupware
	@chmod 0755 distrib/setup distrib/bin/cron.daily distrib/bin/nullgw-config distrib/bin/rc.groupware

_dbutil:
	@echo "dbutil"
	@cd dbutil;$(MAKE)

_server:
	@echo "server"
	@cd server;$(MAKE)

_server_modules:
	@echo "server_modules"
	@cd server_modules;$(MAKE)

_modules:
	@echo "modules"
	@cd modules;$(MAKE)

_sqlite:
	@echo "sqlite"
	@cd sqlite;./make_sqlite build

sslcert:
	openssl req -new -x509 -nodes -out distrib/etc/ssl-cert.pem -keyout distrib/etc/ssl-priv.pem -days 365

autoconf:
	@echo ifnames *.[ch]
	@echo autoscan
	@echo mv configure.scan configure.in
	@echo autoheader
	@echo autoconf

clean:
	@echo -n "Cleaning..."
	@chmod 0755 scripts/lxtool
	@cd dbutil;$(MAKE) clean
	@cd server;$(MAKE) clean
	@cd server_modules;$(MAKE) clean
	@cd modules;$(MAKE) clean
	@./scripts/lxtool clean
	@rm -f distrib/bin/* distrib/lib/* *~
	@rm -f distrib/etc/ssl-cert.pem distrib/etc/ssl-priv.pem
	@echo "done."

distclean: clean
	@cd sqlite;./make_sqlite clean
	@rm -f `find -name *~`
	@echo -n "Running autoconf..."
	@autoconf
	@echo "done."
	@rm -rf autom4te.cache
	@chown -R 0:0 *
	@rm -f config.log config.status include/config.h Makefile Rules.mak

install: _all
	@chown -R 0:0 distrib/*
	@cd distrib;./setup

upgrade: _all
	@chown -R 0:0 distrib/*
	/etc/init.d/nullgroupware stop
	@cd distrib;./setup upgrade
	/etc/init.d/nullgroupware start

wc:
	wc `find -name *.[ch]`

dist:
	@chmod 0755 scripts/lxtool
	@./scripts/lxtool clean
	@$(MAKE)
	@./scripts/lxtool pack

slackdist:
	@chmod 0755 scripts/lxtool
	@./scripts/lxtool clean
	@$(MAKE)
	@./scripts/lxtool slackpack
