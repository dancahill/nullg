<!DOCTYPE HTML PUBLIC '-//W3C//DTD HTML 4.0 Transitional//EN'>
<HTML>
<head>
</head>
<body>
<script language=javascript>
<!--
function changevis(t) {
	if (document.all) {
		var coll=document.all.tags('DIV');
	} else {
		var coll=document.getElementsByTagName('DIV');
	}
	if (coll==null) return;
	for (i=0;i<coll.length;i++) {
		if (coll[i].id!=t) continue;
		if (coll[i].style.display=='block') {
			coll[i].style.display='none';
		} else {
			coll[i].style.display='block';
		}
		break;
	}
}
-->
</script>
<?nsp

function show_subtree(Q, depth, did, pid) {
//	print("<pre>",serialize(Q),"</pre>");
	for (i=0;i<Q._tuples;i++) {
		row=Q['_rows'][i];
		Q2=sqlquery("SELECT id, pid, did, ctime, mtime, class, name FROM nullsd_entries WHERE pid = "+row['id']+" AND did = "+did+" AND class <> 'emailheader' AND class <> 'organization'");
		print("<tr><td>"+("&nbsp;"*10)+"</td>");
		if (Q2._tuples<1) {
			print("<td nowrap width='100%'>",row['id']," - ",row['name']," (",row['class'],")");
		} else {
			print("<td nowrap width='100%'><a href=\"javascript:changevis('tlist"+row['id']+"');\">",row['id']," - ",row['name']," (",row['class'],")</a>");
		}
		if (row['class']=='person') {
			print(" - [<a href='/contacts/view?id="+row['id']+"' target='_blank'>edit</a>]");
		}
		if (Q2._tuples>0) {
			print("<DIV ID='tlist"+row['id']+"' STYLE='display:none'>");
			print("<table border=1 width='100%'><tr><td>");
			show_subtree(Q2, depth+1, did, row['id']);
			print("</td></tr></table>");
			print("</DIV>");
		}
		print("</td></tr>\n");
	}
}

function show_org(row) {
	print("<tr><td nowrap colspan=2>",row['id']," ",row['name']," (",row['class'],")</td></tr>");
	Q=sqlquery("SELECT id, pid, did, ctime, mtime, class, name FROM nullsd_entries WHERE pid = "+row['id']+" AND did = "+row['id']+" AND class <> 'emailheader' AND class <> 'organization'");
	show_subtree(Q, 1, row['id'], row['id']);
}

?>
<table border='1' width='100%'>
<tr bgcolor=gray>
<td colspan=2>Org Tree</td>
</tr>
<?nsp

Q=sqlquery("SELECT id, pid, did, ctime, mtime, class, name FROM nullsd_entries WHERE class = 'organization'");
//print("<pre>",serialize(Q),"</pre>");
for (i=0;i<sizeof(Q._rows);i++) {
	show_org(Q['_rows'][i]);
}

?>
</table>
</body>
</HTML>
