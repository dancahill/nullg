#!/usr/bin/nesla

// single line comment
/*
 * multi line
 * comment
 */

function vars() {
	if (typeof(_SERVER)=='table') {
		print("</FONT></PRE>");
		print(
			"<SCRIPT LANGUAGE=JavaScript>\n<!--\n",
			"function showdebug() {\n",
			"	if (document.getElementById('debug').style.display=='none') {\n",
			"		document.getElementById('debug').style.display='block';\n",
			"	} else {\n",
			"		document.getElementById('debug').style.display='none';\n",
			"	}\n",
			"}\n",
			"// -->\n</SCRIPT>\n"
		);
		print("<A HREF=javascript:showdebug()>SHOW DEBUG</A>\n");
		print("<DIV ID=debug STYLE='display:none'><PRE><FONT SIZE=2>\n");
	}
	print("global _GLOBALS = ");
	printvar(_GLOBALS);
	print(";\n");
	if (typeof(_SERVER)=='table') print("</FONT></PRE></DIV>\n");
	return;
}

function main() {
	global numtests=0;
	global numerrors=0;

	local subf = function () { return 42; }
	include("../samples/_cards.nes");
	include("_expect.nes");
	if (typeof(_SERVER)=='table') {
		print("<HTML><HEAD><TITLE>NESLA WEB TEST</TITLE></HEAD><BODY>");
		print("<H1>NESLA WEB TEST</H1><PRE><FONT SIZE=2>");
	}
	print("STARTING TESTS\n");
	print("-------------------------------------------------------------------\n");
	include("_types.nes");
	print("-------------------------------------------------------------------\n");
	include("_tables.nes");
	print("-------------------------------------------------------------------\n");
	include("_size.nes");
	print("-------------------------------------------------------------------\n");
	include("_scope.nes");
	print("-------------------------------------------------------------------\n");
	include("_string.nes");
	print("-------------------------------------------------------------------\n");
	include("_if.nes");
	print("-------------------------------------------------------------------\n");
	include("_loops.nes");
	print("-------------------------------------------------------------------\n");
	include("_cmp.nes");
	print("-------------------------------------------------------------------\n");
	include("_eval.nes");
	print("-------------------------------------------------------------------\n");
	include("_math.nes");
	print("-------------------------------------------------------------------\n");
	include("_oo.nes");
	print("-------------------------------------------------------------------\n");
	include("_indexes.nes");
	print("-------------------------------------------------------------------\n");
	include("_dl.nes");
	print("-------------------------------------------------------------------\n");
	include("_try.nes");
	print("-------------------------------------------------------------------\n");
	include("_b64.nes");
	print("-------------------------------------------------------------------\n");
	include("_rot13.nes");
	print("-------------------------------------------------------------------\n");
	include("_xml.nes");
	print("-------------------------------------------------------------------\n");
	include("_regex.nes");
	print("-------------------------------------------------------------------\n");
	include("_crypto.nes");
	print("-------------------------------------------------------------------\n");
	include("_tcp.nes");
	print("-------------------------------------------------------------------\n");
//	include("_ldap.nes");
//	print("-------------------------------------------------------------------\n");
//	include("_odbc.nes");
//	print("-------------------------------------------------------------------\n");
	if (_ENV['HOME']!=null) {
		var f=_ENV['HOME']+"/test.nes";
		if (typeof(file.stat(f))=='table') {
			print("\trunning ", f, "\n");
			include(f);
			print("-------------------------------------------------------------------\n");
		}
	}
	if (typeof(sqlquery)=='function') Q=sqlquery("SELECT * FROM nullgs_sessions");
	if (typeof(dirlist)=='function') D=dirlist(_filepath);
	print("\tFINISHED TESTS       = "+runtime()+" seconds\n");
	print("\ttotal tests          = "+tostring(numtests)+"\n");
	expect("total errors", 0, tonumber(numerrors));
	if (numerrors>1) numerrors--;
	print("-------------------------------------------------------------------\n");
	global decomped_script=null;
	global cx=null;
	global cx2=null;
	global _ARGS={};
	global _ENV={};
	vars();
	if (typeof(_SERVER)=='table') print("</BODY></HTML>");
	return;
}
main();
